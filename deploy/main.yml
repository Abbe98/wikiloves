---
- hosts: toolforge
  become: yes
  become_user: "tools.wikiloves"
  gather_facts: no

  vars:
    base_path: /data/project/wikiloves
    checkout_path: "{{ base_path }}/wikiloves"
    toolforge_path: "{{ base_path }}/www/python"
    virtualenv_path: "{{ toolforge_path }}/venv"
    source_path: "{{ toolforge_path }}/src"

  handlers:
    - name: Display message
      debug:
        msg: >
          Deploy done. Please update the Server Admin Log via IRC:
          https://webchat.freenode.net/?channels=#wikimedia-labs

  tasks:
    - name: Ensure directories exist
      file:
        path: "{{ toolforge_path }}"
        state: directory
      tags:
        - paths

    - name: Clone Git repository
      git:
        repo: 'https://github.com/JeanFred/wikiloves'
        dest: '{{ checkout_path }}'
      notify:
        - Display message
      tags:
        - git
        - skip_ansible_lint  # Skip E401, we always want latest version

    - name: Install requirements
      pip:
        requirements: '{{ checkout_path }}/requirements.txt'
        virtualenv: '{{ virtualenv_path }}'
      tags:
        - requirements

    - name: Symlink src directory
      file:
        src: '{{ checkout_path }}'
        path: '{{ source_path }}'
        state: link
      tags:
        - paths
